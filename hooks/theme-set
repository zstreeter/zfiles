#!/bin/bash
# Omarchy theme-set hook for zfiles overlay
# Generates theme configs for zathura and yazi from the current theme's colors
#
# Called with: $1 = theme name (e.g., "tokyo-night")

THEME_NAME="$1"
THEME_DIR="$HOME/.config/omarchy/current/theme"
KITTY_CONF="$THEME_DIR/kitty.conf"

# Parse a color from kitty.conf
get_color() {
    grep "^$1 " "$KITTY_CONF" | awk '{print $2}'
}

# Abort if no kitty.conf
if [[ ! -f "$KITTY_CONF" ]]; then
    echo "theme-set hook: No kitty.conf found, skipping"
    exit 0
fi

# Extract colors
bg=$(get_color "background")
fg=$(get_color "foreground")
sel_bg=$(get_color "selection_background")
sel_fg=$(get_color "selection_foreground")
cursor=$(get_color "cursor")

# Terminal colors
color0=$(get_color "color0")   # black
color1=$(get_color "color1")   # red
color2=$(get_color "color2")   # green
color3=$(get_color "color3")   # yellow
color4=$(get_color "color4")   # blue
color5=$(get_color "color5")   # magenta
color6=$(get_color "color6")   # cyan
color7=$(get_color "color7")   # white
color8=$(get_color "color8")   # bright black
color15=$(get_color "color15") # bright white

# === Generate Zathura Theme ===
ZATHURA_THEME="$HOME/.config/zathura/omarchy-theme"
mkdir -p "$(dirname "$ZATHURA_THEME")"

cat > "$ZATHURA_THEME" << EOF
# Auto-generated by zfiles theme-set hook
# Theme: $THEME_NAME

set default-bg "$bg"
set default-fg "$fg"

set statusbar-bg "$bg"
set statusbar-fg "$fg"

set inputbar-bg "$bg"
set inputbar-fg "$fg"

set notification-bg "$bg"
set notification-fg "$fg"
set notification-error-bg "$color1"
set notification-error-fg "$bg"
set notification-warning-bg "$color3"
set notification-warning-fg "$bg"

set highlight-color "$color3"
set highlight-active-color "$color4"

set completion-bg "$bg"
set completion-fg "$fg"
set completion-group-bg "$color8"
set completion-group-fg "$fg"
set completion-highlight-bg "$color4"
set completion-highlight-fg "$bg"

set index-bg "$bg"
set index-fg "$fg"
set index-active-bg "$color4"
set index-active-fg "$bg"

set recolor
set recolor-lightcolor "$bg"
set recolor-darkcolor "$fg"
set recolor-keephue
EOF

echo "theme-set hook: Generated $ZATHURA_THEME"

# === Generate Yazi Theme ===
YAZI_THEME="$HOME/.config/yazi/omarchy-theme.toml"
mkdir -p "$(dirname "$YAZI_THEME")"

cat > "$YAZI_THEME" << EOF
# Auto-generated by zfiles theme-set hook
# Theme: $THEME_NAME
# Note: This provides basic colors. For full theming, use a matching yazi flavor.

[manager]
cwd = { fg = "$color6" }
hovered = { bg = "$sel_bg", fg = "$sel_fg" }
preview_hovered = { bg = "$sel_bg" }

[status]
separator_open = ""
separator_close = ""
separator_style = { fg = "$color8" }

mode_normal = { bg = "$color4", fg = "$bg", bold = true }
mode_select = { bg = "$color2", fg = "$bg", bold = true }
mode_unset = { bg = "$color5", fg = "$bg", bold = true }

progress_label = { fg = "$fg" }
progress_normal = { fg = "$color4" }
progress_error = { fg = "$color1" }

permissions_t = { fg = "$color2" }
permissions_r = { fg = "$color3" }
permissions_w = { fg = "$color1" }
permissions_x = { fg = "$color6" }
permissions_s = { fg = "$color5" }

[select]
border = { fg = "$color4" }
active = { fg = "$color5", bold = true }
inactive = { fg = "$fg" }

[input]
border = { fg = "$color4" }
title = { fg = "$fg" }
value = { fg = "$fg" }
selected = { bg = "$sel_bg" }

[completion]
border = { fg = "$color4" }
active = { bg = "$sel_bg" }
inactive = { fg = "$color8" }

[tasks]
border = { fg = "$color4" }
title = { fg = "$fg" }
hovered = { fg = "$color5" }

[which]
mask = { bg = "$color8" }
cand = { fg = "$color6" }
rest = { fg = "$color8" }
desc = { fg = "$color5" }
separator = " â†’ "
separator_style = { fg = "$color8" }

[help]
on = { fg = "$color6" }
run = { fg = "$color5" }
desc = { fg = "$fg" }
hovered = { bg = "$sel_bg", bold = true }
footer = { fg = "$color8" }

[notify]
title_info = { fg = "$color2" }
title_warn = { fg = "$color3" }
title_error = { fg = "$color1" }

[filetype]
rules = [
    { name = "*", fg = "$fg" },
    { name = "*/", fg = "$color4" },
]
EOF

echo "theme-set hook: Generated $YAZI_THEME"
